<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>H.A.C.A</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            margin-bottom: 15px;
            font-size: 28px;
            font-weight: 400;
        }
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            background: #03a9f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #0288d1; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.secondary { background: #757575; }
        
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: white;
            padding: 4px;
            border-radius: 8px;
        }
        .tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 6px;
        }
        .tab:hover { background: #f5f5f5; }
        .tab.active { background: #03a9f4; color: white; }
        
        .view { display: none; }
        .view.active { display: block; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 48px;
            font-weight: 300;
        }
        .stat-icon { font-size: 32px; margin-bottom: 10px; }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .card h2 { margin-bottom: 15px; font-size: 20px; }
        
        .issue-item {
            padding: 15px;
            margin: 10px 0;
            background: #f5f5f5;
            border-left: 4px solid #03a9f4;
            border-radius: 4px;
        }
        .issue-item.high { border-left-color: #f44336; }
        .issue-item.medium { border-left-color: #ff9800; }
        .issue-item.low { border-left-color: #ffc107; }
        
        .severity-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .severity-badge.high { background: #ffebee; color: #c62828; }
        .severity-badge.medium { background: #fff3e0; color: #e65100; }
        .severity-badge.low { background: #fffde7; color: #f57f17; }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty-state-icon { font-size: 64px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è H.A.C.A - Home Assistant Config Auditor</h1>
            <div class="actions">
                <button id="btn-scan">üîç Scan Complet</button>
                <button id="btn-scan-auto">ü§ñ Scan Automations</button>
                <button id="btn-scan-entity">‚ö° Scan Entit√©s</button>
                <button class="secondary" id="btn-report">üìÑ Rapport</button>
                <button class="secondary" id="btn-refresh">üîÑ Actualiser</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-view="dashboard">üìä Dashboard</button>
            <button class="tab" data-view="automations">ü§ñ Automations</button>
            <button class="tab" data-view="entities">‚ö° Entit√©s</button>
            <button class="tab" data-view="performance">‚öôÔ∏è Performance</button>
        </div>

        <div id="view-dashboard" class="view active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-icon">üíö</div>
                    <div class="stat-label">Health Score</div>
                    <div class="stat-value" id="health">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ü§ñ</div>
                    <div class="stat-label">Automations</div>
                    <div class="stat-value" id="auto">0</div>
                    <div class="stat-label">probl√®mes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-label">Entit√©s</div>
                    <div class="stat-value" id="entity">0</div>
                    <div class="stat-label">probl√®mes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚öôÔ∏è</div>
                    <div class="stat-label">Performance</div>
                    <div class="stat-value" id="perf">0</div>
                    <div class="stat-label">probl√®mes</div>
                </div>
            </div>
            
            <div class="card">
                <h2>R√©sum√©</h2>
                <div id="summary"></div>
            </div>
        </div>

        <div id="view-automations" class="view">
            <div class="card">
                <h2>Probl√®mes d'Automations</h2>
                <div id="automation-issues"></div>
            </div>
        </div>

        <div id="view-entities" class="view">
            <div class="card">
                <h2>Probl√®mes d'Entit√©s</h2>
                <div id="entity-issues"></div>
            </div>
        </div>

        <div id="view-performance" class="view">
            <div class="card">
                <h2>Probl√®mes de Performance</h2>
                <div id="performance-issues"></div>
            </div>
        </div>
    </div>

    <script>
        console.log('[HACA] Panel starting...');
        
        let data = {
            health_score: 0,
            automation_issues: 0,
            entity_issues: 0,
            performance_issues: 0,
            automation_issue_list: [],
            entity_issue_list: [],
            performance_issue_list: []
        };
        
        // Utiliser l'API REST de Home Assistant
        async function callService(domain, service, serviceData = {}) {
            try {
                const response = await fetch(`/api/services/${domain}/${service}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(serviceData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('[HACA] Service call error:', error);
                throw error;
            }
        }
        
        async function getStates() {
            try {
                const response = await fetch('/api/states');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('[HACA] Get states error:', error);
                throw error;
            }
        }
        
        async function loadData() {
            try {
                console.log('[HACA] Loading data...');
                const states = await getStates();
                
                // Extraire les sensors H.A.C.A
                for (const state of states) {
                    const id = state.entity_id;
                    if (!id.startsWith('sensor.h_a_c_a_')) continue;
                    
                    if (id.includes('health_score')) {
                        data.health_score = parseInt(state.state) || 0;
                    } else if (id.includes('automation_issues')) {
                        data.automation_issues = parseInt(state.state) || 0;
                        if (state.attributes && state.attributes.automation_issue_list) {
                            data.automation_issue_list = state.attributes.automation_issue_list;
                        }
                    } else if (id.includes('entity_issues')) {
                        data.entity_issues = parseInt(state.state) || 0;
                        if (state.attributes && state.attributes.entity_issue_list) {
                            data.entity_issue_list = state.attributes.entity_issue_list;
                        }
                    } else if (id.includes('performance_issues')) {
                        data.performance_issues = parseInt(state.state) || 0;
                        if (state.attributes && state.attributes.performance_issue_list) {
                            data.performance_issue_list = state.attributes.performance_issue_list;
                        }
                    }
                }
                
                updateUI();
                console.log('[HACA] Data loaded');
                
            } catch (error) {
                console.error('[HACA] Error loading data:', error);
            }
        }
        
        function updateUI() {
            document.getElementById('health').textContent = data.health_score + '%';
            document.getElementById('auto').textContent = data.automation_issues;
            document.getElementById('entity').textContent = data.entity_issues;
            document.getElementById('perf').textContent = data.performance_issues;
            
            renderSummary();
            renderIssues(data.automation_issue_list, 'automation-issues');
            renderIssues(data.entity_issue_list, 'entity-issues');
            renderIssues(data.performance_issue_list, 'performance-issues');
        }
        
        function renderSummary() {
            const all = [
                ...data.automation_issue_list,
                ...data.entity_issue_list,
                ...data.performance_issue_list
            ];
            
            const container = document.getElementById('summary');
            if (all.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ú®</div><div>Aucun probl√®me d√©tect√©</div></div>';
                return;
            }
            
            const high = all.filter(i => i.severity === 'high').length;
            const medium = all.filter(i => i.severity === 'medium').length;
            const low = all.filter(i => i.severity === 'low').length;
            
            container.innerHTML = `
                <p><strong>Total :</strong> ${all.length} probl√®mes</p>
                <p><span class="severity-badge high">HIGH</span> ${high} critiques</p>
                <p><span class="severity-badge medium">MEDIUM</span> ${medium} moyens</p>
                <p><span class="severity-badge low">LOW</span> ${low} mineurs</p>
            `;
        }
        
        function renderIssues(issues, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (issues.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ú®</div><div>Aucun probl√®me</div></div>';
                return;
            }
            
            container.innerHTML = issues.map(issue => `
                <div class="issue-item ${issue.severity}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <strong>${issue.alias || issue.entity_id}</strong><br>
                            <small style="color: #666;">${issue.entity_id}</small>
                        </div>
                        <span class="severity-badge ${issue.severity}">${issue.severity}</span>
                    </div>
                    <div style="margin: 8px 0;">${issue.message}</div>
                    ${issue.location ? `<small style="color: #666;">üìç ${issue.location}</small><br>` : ''}
                    ${issue.recommendation ? `<em style="font-size: 13px; color: #666;">üí° ${issue.recommendation}</em>` : ''}
                </div>
            `).join('');
        }
        
        async function scanAll() {
            const btn = document.getElementById('btn-scan');
            btn.disabled = true;
            btn.textContent = '‚è≥ Scan...';
            
            try {
                await callService('config_auditor', 'scan_all');
                alert('‚úÖ Scan termin√© ! Cliquez sur "Actualiser" pour voir les r√©sultats.');
            } catch (error) {
                console.error('[HACA] Scan error:', error);
                alert('‚ùå Erreur: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Scan Complet';
            }
        }
        
        async function scanAutomations() {
            const btn = document.getElementById('btn-scan-auto');
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            
            try {
                await callService('config_auditor', 'scan_automations');
                alert('‚úÖ Scan termin√© ! Cliquez sur "Actualiser" pour voir les r√©sultats.');
            } catch (error) {
                console.error('[HACA] Error:', error);
                alert('‚ùå Erreur: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ü§ñ Scan Automations';
            }
        }
        
        async function scanEntities() {
            const btn = document.getElementById('btn-scan-entity');
            btn.disabled = true;
            btn.textContent = '‚è≥...';
            
            try {
                await callService('config_auditor', 'scan_entities');
                alert('‚úÖ Scan termin√© ! Cliquez sur "Actualiser" pour voir les r√©sultats.');
            } catch (error) {
                console.error('[HACA] Error:', error);
                alert('‚ùå Erreur: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö° Scan Entit√©s';
            }
        }
        
        async function generateReport() {
            try {
                await callService('config_auditor', 'generate_report');
                alert('‚úÖ Rapport g√©n√©r√© dans /config/.haca_reports/');
            } catch (error) {
                alert('‚ùå Erreur: ' + error.message);
            }
        }
        
        function switchView(view) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            document.querySelector(`#view-${view}`).classList.add('active');
        }
        
        // Event listeners
        document.getElementById('btn-scan').addEventListener('click', scanAll);
        document.getElementById('btn-scan-auto').addEventListener('click', scanAutomations);
        document.getElementById('btn-scan-entity').addEventListener('click', scanEntities);
        document.getElementById('btn-report').addEventListener('click', generateReport);
        document.getElementById('btn-refresh').addEventListener('click', () => {
            loadData();
            alert('‚úÖ Donn√©es actualis√©es');
        });
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => switchView(tab.dataset.view));
        });
        
        // Charger les donn√©es au d√©marrage
        loadData();
        
        console.log('[HACA] Panel ready');
    </script>
</body>
</html>
